<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - College Scheduling System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
    }

    .header .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #ddd;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #999;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .nav-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .nav-tab:hover {
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .stat-card h3 {
      color: #999;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .section {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #229954;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input:read-only {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table thead {
      background: #f8f9fa;
      border-bottom: 2px solid #ddd;
    }

    table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    table tr:hover {
      background: #f8f9fa;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .close-btn:hover {
      color: #333;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn-edit {
      background: #3498db;
      color: white;
    }

    .action-btn-edit:hover {
      background: #2980b9;
    }

    .action-btn-delete {
      background: #e74c3c;
      color: white;
    }

    .action-btn-delete:hover {
      background: #c0392b;
    }

    .action-btn-approve {
      background: #27ae60;
      color: white;
    }

    .action-btn-approve:hover {
      background: #229954;
    }

    .action-btn-reject {
      background: #e67e22;
      color: white;
    }

    .action-btn-reject:hover {
      background: #d35400;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-bar input {
      flex: 1;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }

      .nav-tabs {
        flex-direction: column;
      }

      table {
        font-size: 12px;
      }

      table th, table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ“š Admin Dashboard</h1>
    <div class="user-info">
      <span id="userEmail"></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
      <button class="nav-tab" onclick="switchTab('staff')">Staff Management</button>
      <button class="nav-tab" onclick="switchTab('timetable')">Timetables</button>
      <button class="nav-tab" onclick="switchTab('leave')">Leave Requests</button>
      <button class="nav-tab" onclick="switchTab('scheduling')">Scheduling</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Staff</h3>
          <div class="value" id="totalStaffCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Currently Logged In</h3>
          <div class="value" id="loggedInCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Pending Leave Requests</h3>
          <div class="value" id="pendingLeaveCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Pending Schedules</h3>
          <div class="value" id="pendingScheduleCount">-</div>
        </div>
      </div>

      <div class="section">
        <h2>Recent Activity</h2>
        <div id="recentActivityTable"></div>
      </div>
    </div>

    <!-- Staff Management Tab -->
    <div id="staff" class="tab-content">
      <div class="section">
        <h2>Staff Members <button class="btn btn-primary" onclick="openStaffModal()">+ Add Staff</button></h2>
        <div class="search-bar">
          <input type="text" id="staffSearch" placeholder="Search by name or email..." onkeyup="filterStaffTable()">
        </div>
        <div id="staffTableContainer"></div>
      </div>
    </div>

    <!-- Timetable Tab -->
    <div id="timetable" class="tab-content">
      <div class="section">
        <h2>Timetables <button class="btn btn-primary" onclick="openTimetableModal()">+ Add Timetable Entry</button></h2>
        <div class="search-bar">
          <input type="text" id="timetableSearch" placeholder="Search by course or staff..." onkeyup="filterTimetableTable()">
        </div>
        <div id="timetableTableContainer"></div>
      </div>
    </div>

    <!-- Leave Requests Tab -->
    <div id="leave" class="tab-content">
      <div class="section">
        <h2>Leave Requests</h2>
        <div id="leaveTableContainer"></div>
      </div>
    </div>

    <!-- Scheduling Tab -->
    <div id="scheduling" class="tab-content">
      <div class="section">
        <h2>Schedule Assignments</h2>
        <div id="schedulingTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Staff Modal -->
  <div id="staffModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="staffModalTitle">Add Staff Member</h2>
        <button class="close-btn" onclick="closeStaffModal()">Ã—</button>
      </div>
      <div id="staffMessage"></div>
      <form id="staffForm" onsubmit="saveStaff(event)">
        <div class="form-group">
          <label for="staffName">Name *</label>
          <input type="text" id="staffName" required>
        </div>
        <div class="form-group" id="emailGroup">
          <label for="staffEmail">Email *</label>
          <input type="email" id="staffEmail" required>
        </div>
        <div class="form-group" id="passwordGroup">
          <label for="staffPassword">Password *</label>
          <input type="password" id="staffPassword" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="staffDepartment">Department</label>
            <input type="text" id="staffDepartment">
          </div>
          <div class="form-group">
            <label for="staffPhone">Phone</label>
            <input type="tel" id="staffPhone">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="staffQualification">Qualification</label>
            <input type="text" id="staffQualification">
          </div>
          <div class="form-group">
            <label for="staffHireDate">Hire Date</label>
            <input type="date" id="staffHireDate">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Staff Member</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeStaffModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Timetable Modal -->
  <div id="timetableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Timetable Entry</h2>
        <button class="close-btn" onclick="closeTimetableModal()">Ã—</button>
      </div>
      <div id="timetableMessage"></div>
      <form id="timetableForm" onsubmit="saveTimetable(event)">
        <div class="form-group">
          <label for="timetableStaff">Staff Member *</label>
          <select id="timetableStaff" required></select>
        </div>
        <div class="form-group">
          <label for="timetableCourse">Course Name *</label>
          <input type="text" id="timetableCourse" required>
        </div>
        <div class="form-group">
          <label for="timetableCourseCode">Course Code</label>
          <input type="text" id="timetableCourseCode">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="timetableDay">Day of Week *</label>
            <select id="timetableDay" required>
              <option value="">Select Day</option>
              <option value="I">I</option>
              <option value="II">II</option>
              <option value="III">III</option>
              <option value="IV">IV</option>
              <option value="V">V</option>
              <option value="VI">VI</option>
            </select>
          </div>
          <div class="form-group">
            <label for="timetableTime">Start Time *</label>
            <input type="time" id="timetableTime" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="timetableEndTime">End Time *</label>
            <input type="time" id="timetableEndTime" required>
          </div>
          <div class="form-group">
            <label for="timetableClassroom">Classroom</label>
            <input type="text" id="timetableClassroom">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="timetableBatch">Batch</label>
            <input type="text" id="timetableBatch">
          </div>
          <div class="form-group">
            <label for="timetableSemester">Semester</label>
            <input type="text" id="timetableSemester">
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Timetable</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeTimetableModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Override Assignment Modal -->
  <div id="overrideModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Override Assignment</h2>
        <button class="close-btn" onclick="closeOverrideModal()">Ã—</button>
      </div>
      <div id="overrideMessage"></div>
      <form onsubmit="submitOverride(event)">
        <input type="hidden" id="overrideAssignmentId" />
        <div class="form-group">
          <label>Select Replacement Staff *</label>
          <select id="overrideStaffSelect" required></select>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
          <button type="submit" class="btn btn-primary" style="flex:1;">Override</button>
          <button type="button" class="btn btn-secondary" style="flex:1;" onclick="closeOverrideModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allStaff = [];
    let allTimetables = [];
    let allLeaveRequests = [];
    let allScheduleAssignments = [];
    let allActivityLogs = [];
    let editingStaffId = null;

    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadDashboardData();
      setInterval(loadDashboardData, 30000);
    });

    function checkAuth() {
      fetch('/api/auth/session')
        .then(res => res.json())
        .then(data => {
          if (!data.authenticated || data.role !== 'admin') {
            window.location.href = '/login.html';
          } else {
            document.getElementById('userEmail').textContent = data.email;
          }
        })
        .catch(error => {
          console.error('Auth check error:', error);
          window.location.href = '/login.html';
        });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'staff' && allStaff.length === 0) loadStaff();
      if (tabName === 'timetable' && allTimetables.length === 0) loadTimetables();
      if (tabName === 'leave' && allLeaveRequests.length === 0) loadLeaveRequests();
      if (tabName === 'scheduling' && allScheduleAssignments.length === 0) loadScheduleAssignments();
    }

    function loadDashboardData() {
      Promise.all([
        fetch('/api/stats/staff-count').then(r => r.json()),
        fetch('/api/stats/logged-in-staff').then(r => r.json()),
        fetch('/api/leave-requests').then(r => r.json()),
        fetch('/api/schedule-assignments').then(r => r.json()),
        fetch('/api/activity-logs').then(r => r.json())
      ])
      .then(([staffCount, loggedIn, leaves, schedules, logs]) => {
        document.getElementById('totalStaffCount').textContent = staffCount.total_staff || 0;
        document.getElementById('loggedInCount').textContent = loggedIn.logged_in_staff || 0;
        document.getElementById('pendingLeaveCount').textContent = leaves.filter(l => l.status === 'pending').length;
        document.getElementById('pendingScheduleCount').textContent = schedules.filter(s => s.status === 'pending').length;
        allActivityLogs = logs;
        renderRecentActivity();
      })
      .catch(error => console.error('Error loading dashboard:', error));
    }

    function renderRecentActivity() {
      const recent = allActivityLogs.slice(0, 10);
      let html = '<table><thead><tr><th>User Email</th><th>Login Time</th><th>Status</th></tr></thead><tbody>';
      
      if (recent.length === 0) {
        html += '<tr><td colspan="3">No activity logs yet.</td></tr>';
      } else {
        recent.forEach(log => {
          const status = log.is_successful ? 
            '<span class="status-badge status-approved">Successful</span>' : 
            '<span class="status-badge status-rejected">Failed</span>';
          html += `<tr>
            <td>${log.email}</td>
            <td>${new Date(log.login_time).toLocaleString()}</td>
            <td>${status}</td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('recentActivityTable').innerHTML = html;
    }

    function loadStaff() {
      fetch('/api/staff')
        .then(res => res.json())
        .then(data => {
          allStaff = data;
          renderStaffTable();
        })
        .catch(error => console.error('Error loading staff:', error));
    }

    function renderStaffTable() {
      let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Phone</th><th>Actions</th></tr></thead><tbody>';
      
      if (allStaff.length === 0) {
        html += '<tr><td colspan="5">No staff members found.</td></tr>';
      } else {
        allStaff.forEach(staff => {
          html += `<tr>
            <td>${staff.name}</td>
            <td>${staff.email}</td>
            <td>${staff.department || '-'}</td>
            <td>${staff.phone || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn action-btn-edit" onclick="editStaff(${staff.id})">Edit</button>
                <button class="action-btn action-btn-delete" onclick="deleteStaff(${staff.id})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('staffTableContainer').innerHTML = html;
    }

    function filterStaffTable() {
      const search = document.getElementById('staffSearch').value.toLowerCase();
      const filtered = allStaff.filter(s => 
        s.name.toLowerCase().includes(search) || 
        s.email.toLowerCase().includes(search)
      );
      
      let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Phone</th><th>Actions</th></tr></thead><tbody>';
      
      if (filtered.length === 0) {
        html += '<tr><td colspan="5">No staff members found matching your search.</td></tr>';
      } else {
        filtered.forEach(staff => {
          html += `<tr>
            <td>${staff.name}</td>
            <td>${staff.email}</td>
            <td>${staff.department || '-'}</td>
            <td>${staff.phone || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn action-btn-edit" onclick="editStaff(${staff.id})">Edit</button>
                <button class="action-btn action-btn-delete" onclick="deleteStaff(${staff.id})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('staffTableContainer').innerHTML = html;
    }

    function openStaffModal() {
      editingStaffId = null;
      document.getElementById('staffModalTitle').textContent = 'Add Staff Member';
      document.getElementById('staffForm').reset();
      document.getElementById('staffEmail').readOnly = false;
      document.getElementById('staffPassword').required = true;
      document.getElementById('passwordGroup').style.display = 'block';
      document.getElementById('staffModal').classList.add('show');
      document.getElementById('staffMessage').innerHTML = '';
    }

    function closeStaffModal() {
      document.getElementById('staffModal').classList.remove('show');
      editingStaffId = null;
    }

    function saveStaff(event) {
      event.preventDefault();
      
      const name = document.getElementById('staffName').value;
      const email = document.getElementById('staffEmail').value;
      const password = document.getElementById('staffPassword').value;
      const department = document.getElementById('staffDepartment').value;
      const phone = document.getElementById('staffPhone').value;
      const qualification = document.getElementById('staffQualification').value;
      const hire_date = document.getElementById('staffHireDate').value;

      const isEditing = editingStaffId !== null;
      const url = isEditing ? `/api/staff/${editingStaffId}` : '/api/staff';
      const method = isEditing ? 'PUT' : 'POST';
      
      const body = isEditing 
        ? { name, department, phone, qualification, hire_date }
        : { name, email, password, department, phone, qualification, hire_date };

      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(res => res.json())
      .then(data => {
        if (data.id || data.success) {
          showMessage('staffMessage', `Staff member ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
          setTimeout(() => {
            closeStaffModal();
            loadStaff();
          }, 1500);
        } else {
          showMessage('staffMessage', data.error || `Error ${isEditing ? 'updating' : 'adding'} staff`, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('staffMessage', `Error ${isEditing ? 'updating' : 'adding'} staff`, 'error');
      });
    }

    function editStaff(id) {
      const staff = allStaff.find(s => s.id === id);
      if (staff) {
        editingStaffId = id;
        document.getElementById('staffModalTitle').textContent = 'Edit Staff Member';
        document.getElementById('staffName').value = staff.name;
        document.getElementById('staffEmail').value = staff.email;
        document.getElementById('staffEmail').readOnly = true;
        document.getElementById('staffPassword').value = '';
        document.getElementById('staffPassword').required = false;
        document.getElementById('passwordGroup').style.display = 'none';
        document.getElementById('staffDepartment').value = staff.department || '';
        document.getElementById('staffPhone').value = staff.phone || '';
        document.getElementById('staffQualification').value = staff.qualification || '';
        document.getElementById('staffHireDate').value = staff.hire_date || '';
        document.getElementById('staffModal').classList.add('show');
        document.getElementById('staffMessage').innerHTML = '';
      }
    }

    function deleteStaff(id) {
      if (confirm('Are you sure you want to delete this staff member? This action cannot be undone.')) {
        fetch(`/api/staff/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.success || data.message) {
              alert('Staff member deleted successfully!');
              loadStaff();
            } else {
              alert(data.error || 'Error deleting staff member');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting staff member');
          });
      }
    }

    function loadTimetables() {
      Promise.all([
        fetch('/api/timetables').then(res => res.json()),
        fetch('/api/staff').then(res => res.json())
      ])
      .then(([timetables, staff]) => {
        allTimetables = timetables;
        const staffSelect = document.getElementById('timetableStaff');
        staffSelect.innerHTML = '<option value="">Select Staff Member</option>';
        staff.forEach(s => {
          staffSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
        renderTimetableTable();
      })
      .catch(error => console.error('Error loading timetables:', error));
    }

    function renderTimetableTable() {
      let html = '<table><thead><tr><th>Course</th><th>Staff</th><th>Day</th><th>Time</th><th>Classroom</th><th>Batch</th><th>Actions</th></tr></thead><tbody>';
      
      if (allTimetables.length === 0) {
        html += '<tr><td colspan="7">No timetable entries found.</td></tr>';
      } else {
        allTimetables.forEach(timetable => {
          html += `<tr>
            <td>${timetable.course_name}</td>
            <td>${timetable.name}</td>
            <td>${timetable.day_of_week}</td>
            <td>${timetable.start_time} - ${timetable.end_time}</td>
            <td>${timetable.classroom || '-'}</td>
            <td>${timetable.batch || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn action-btn-delete" onclick="deleteTimetable(${timetable.id})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('timetableTableContainer').innerHTML = html;
    }

    function filterTimetableTable() {
      const search = document.getElementById('timetableSearch').value.toLowerCase();
      const filtered = allTimetables.filter(t => 
        t.course_name.toLowerCase().includes(search) || 
        t.name.toLowerCase().includes(search)
      );
      
      let html = '<table><thead><tr><th>Course</th><th>Staff</th><th>Day</th><th>Time</th><th>Classroom</th><th>Batch</th><th>Actions</th></tr></thead><tbody>';
      
      if (filtered.length === 0) {
        html += '<tr><td colspan="7">No timetable entries found matching your search.</td></tr>';
      } else {
        filtered.forEach(timetable => {
          html += `<tr>
            <td>${timetable.course_name}</td>
            <td>${timetable.name}</td>
            <td>${timetable.day_of_week}</td>
            <td>${timetable.start_time} - ${timetable.end_time}</td>
            <td>${timetable.classroom || '-'}</td>
            <td>${timetable.batch || '-'}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn action-btn-delete" onclick="deleteTimetable(${timetable.id})">Delete</button>
              </div>
            </td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('timetableTableContainer').innerHTML = html;
    }

    function openTimetableModal() {
      document.getElementById('timetableForm').reset();
      document.getElementById('timetableModal').classList.add('show');
      document.getElementById('timetableMessage').innerHTML = '';
      if (allStaff.length === 0) {
        loadTimetables();
      }
    }

    function closeTimetableModal() {
      document.getElementById('timetableModal').classList.remove('show');
    }

    function saveTimetable(event) {
      event.preventDefault();
      const data = {
        staff_id: parseInt(document.getElementById('timetableStaff').value),
        course_name: document.getElementById('timetableCourse').value,
        course_code: document.getElementById('timetableCourseCode').value,
        day_of_week: document.getElementById('timetableDay').value,
        start_time: document.getElementById('timetableTime').value,
        end_time: document.getElementById('timetableEndTime').value,
        classroom: document.getElementById('timetableClassroom').value,
        batch: document.getElementById('timetableBatch').value,
        semester: document.getElementById('timetableSemester').value
      };

      fetch('/api/timetables', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          showMessage('timetableMessage', 'Timetable added successfully!', 'success');
          setTimeout(() => {
            closeTimetableModal();
            loadTimetables();
          }, 1500);
        } else {
          showMessage('timetableMessage', data.error || 'Error adding timetable', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('timetableMessage', 'Error adding timetable', 'error');
      });
    }

    function deleteTimetable(id) {
      if (confirm('Are you sure you want to delete this timetable entry?')) {
        fetch(`/api/timetables/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.success || data.message) {
              alert('Timetable deleted successfully!');
              loadTimetables();
            } else {
              alert(data.error || 'Error deleting timetable');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting timetable');
          });
      }
    }

    function loadLeaveRequests() {
      fetch('/api/leave-requests')
        .then(res => res.json())
        .then(data => {
          allLeaveRequests = data;
          renderLeaveRequestsTable();
        })
        .catch(error => console.error('Error loading leave requests:', error));
    }

    function renderLeaveRequestsTable() {
      let html = '<table><thead><tr><th>Staff Name</th><th>Type</th><th>From</th><th>To</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      
      if (allLeaveRequests.length === 0) {
        html += '<tr><td colspan="6">No leave requests found.</td></tr>';
      } else {
        allLeaveRequests.forEach(leave => {
          const status = `<span class="status-badge status-${leave.status}">${leave.status.toUpperCase()}</span>`;
          let actions = '';
          if (leave.status === 'pending') {
            actions = `<div class="action-buttons">
              <button class="action-btn action-btn-approve" onclick="approveLeave(${leave.id})">Approve</button>
              <button class="action-btn action-btn-reject" onclick="rejectLeave(${leave.id})">Reject</button>
            </div>`;
          }
          html += `<tr>
            <td>${leave.name}</td>
            <td>${leave.leave_type.replace('_', ' ').toUpperCase()}</td>
            <td>${leave.start_date}</td>
            <td>${leave.end_date}</td>
            <td>${status}</td>
            <td>${actions}</td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('leaveTableContainer').innerHTML = html;
    }

    function approveLeave(id) {
      if (confirm('Are you sure you want to approve this leave request?')) {
        fetch(`/api/leave-request/${id}/approve`, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
          if (data.id || data.success) {
            alert('Leave request approved successfully!');
            loadLeaveRequests();
            loadDashboardData();
          } else {
            alert(data.error || 'Error approving leave request');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error approving leave request');
        });
      }
    }

    function rejectLeave(id) {
      if (confirm('Are you sure you want to reject this leave request?')) {
        fetch(`/api/leave-request/${id}/reject`, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
          if (data.id || data.success) {
            alert('Leave request rejected!');
            loadLeaveRequests();
            loadDashboardData();
          } else {
            alert(data.error || 'Error rejecting leave request');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error rejecting leave request');
        });
      }
    }

    function loadScheduleAssignments() {
      fetch('/api/schedule-assignments')
        .then(res => res.json())
        .then(data => {
          allScheduleAssignments = data;
          renderScheduleAssignmentsTable();
        })
        .catch(error => console.error('Error loading schedule assignments:', error));
    }

    function renderScheduleAssignmentsTable() {
      let html = '<table><thead><tr><th>Course</th><th>Original Staff</th><th>Assigned Staff</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      
      if (allScheduleAssignments.length === 0) {
        html += '<tr><td colspan="6">No schedule assignments found.</td></tr>';
      } else {
        allScheduleAssignments.forEach(assignment => {
          const status = `<span class="status-badge status-${assignment.status}">${assignment.status.toUpperCase()}</span>`;
          html += `<tr>
            <td>${assignment.course_name}</td>
            <td>${assignment.original_staff}</td>
            <td>${assignment.assigned_staff || '-'}</td>
            <td>${assignment.scheduled_date}</td>
            <td>${status}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn action-btn-edit" onclick="overrideAssignment(${assignment.id})">Override</button>
              </div>
            </td>
          </tr>`;
        });
      }
      
      html += '</tbody></table>';
      document.getElementById('schedulingTableContainer').innerHTML = html;
    }

    function overrideAssignment(id) {
      document.getElementById("overrideAssignmentId").value = id;
      document.getElementById("overrideModal").classList.add("show");
      loadOverrideStaff();
    }

    function loadOverrideStaff() {
      fetch("/api/staff")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("overrideStaffSelect");
          select.innerHTML = `<option value="">Select staff</option>`;
          data.forEach(staff => {
            select.innerHTML += `<option value="${staff.id}">${staff.name}</option>`;
          });
        })
        .catch(error => console.error('Error loading staff:', error));
    }

    function submitOverride(event) {
      event.preventDefault();
      const assignmentId = document.getElementById("overrideAssignmentId").value;
      const replacement_staff_id = document.getElementById("overrideStaffSelect").value;

      if (!replacement_staff_id) {
        showMessage("overrideMessage", "Please select a staff member", "error");
        return;
      }

      fetch(`/api/schedule-assignments/${assignmentId}/override`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ replacement_staff_id: parseInt(replacement_staff_id) })
      })
      .then(res => res.json())
      .then(data => {
        if (data.id || data.success) {
          showMessage("overrideMessage", "Assignment overridden successfully!", "success");
          setTimeout(() => {
            closeOverrideModal();
            loadScheduleAssignments();
          }, 1500);
        } else {
          showMessage("overrideMessage", data.error || "Override failed", "error");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage("overrideMessage", "Override failed", "error");
      });
    }

    function closeOverrideModal() {
      document.getElementById("overrideModal").classList.remove("show");
      document.getElementById("overrideMessage").innerHTML = '';
    }

    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="message message-${type}">${message}</div>`;
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        fetch('/api/auth/logout', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            window.location.href = '/login.html';
          })
          .catch(error => {
            console.error('Logout error:', error);
            window.location.href = '/login.html';
          });
      }
    }
  </script>
</body>
</html>